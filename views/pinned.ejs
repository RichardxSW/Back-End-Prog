<div class="content">
  <div class="folderPopup" id="folderPopup" style="display: none;">
    <div class="top">
        <i class="fa-solid fa-folder-plus fa-lg" style="color: #ffffff;"></i><p>Add Recipe to Folder</p>
        <span class="close" onclick="closeAddPopup()"><i class="fa fa-close" style="color: #ffffff;"></i></span>
    </div>
    <div class="addContent">
      <% folders.forEach(folder => { %>
        <label class="custom-checkbox">
          <input type="checkbox" id="<%= folder._id %>" value="<%= folder._id %>" hidden>
          <span class="checkmark"></span>
          <span class="name"><%= folder.name %></span>
        </label><br>
      <% }); %>
    </div>
    <div class="button-container">
      <a href="#" onclick="uncheckAll()">Uncheck All</a>
      <button id="doneButton">Done</button>
    </div>
  </div>
  <div class="popup" id="popup">
    <div class="top">
      <i class="fa-solid fa-folder-plus fa-lg" style="color: #ffffff;"></i><p>New Folder</p>
      <span class="close" onclick="closePopup()"><i class="fa fa-close" style="color: #ffffff;"></i></span>
    </div>
    <div class="popup-content">
      <form id="folderForm">
        <div class="name">
          <label for="folderName">Folder Name</label><br>
          <input type="text" id="folderName" name="folderName" maxlength="10" placeholder="Give your folder a name"><br>
        </div>
        <div class="desc">
        <label for="description">Description (optional)</label><br>
          <textarea id="description" name="description" maxlength="300" placeholder="Describe your folder"></textarea><br>
          <div class="count" id="charCount">0/300 characters</div>
        </div>
        <div class="button-container">
          <a href="#" class="cancel" onclick="closePopup()">Cancel</a>
          <button type="submit" id="confirmButton">Create Folder</button>
        </div> 
      </form>
    </div>
  </div>
  <div class="selection">
    <div class="select">
      <a href="#" id="savedBtn" class="active"><i class="fa-solid fa-bookmark"></i>Pinned Recipes</a>
      <a href="/latest-seen" id="recentBtn"><i class="fa-regular fa-clock"></i>Recently Viewed</a>
    </div>
    <div class="my-folder">
      <p>MY FOLDERS</p>
      <button onclick="openPopup()">
        <i class="fa-solid fa-plus"></i>
        <p>New Folder</p>
      </button>
      <div class="created">
        <% folders.forEach(folder => { %>
          <a class="folder" href="/folder/<%= folder._id %>">
            <img src="/img/recipe-add-photo.png"/>
            <%= folder.name %>
          </a>
        <% }); %>
      </div>
    </div>
  </div>
  <div class="result">
    <h3>Pinned Recipes</h3>
    <div class="containerTotal">
      <p id="totalResults"><%= savedRecipesCount.length %> recipes</p>
    </div>
    <div class="cardwrap">
      <% if (savedRecipesCount.length > 0) { %>
        <% savedRecipes.forEach((recipe) => { %>
          <%- include('layouts/cardPinned', { recipe: recipe}) %>
        <% }); %>
      <% } else { %>
        <h4>You haven't saved anything yet. Start browsing!</h4>
      <% } %>
    </div>
    <% if (savedRecipesCount.length > limit) { %>
      <div class="pagination">
          <a href="<%= currentPage > 1 ? '/pinned?page=' + (currentPage - 1) : '#' %>" class="<%= currentPage > 1 ? 'prev' : 'prev disabled' %>">
              <i class="fa-solid fa-arrow-left"></i>
          </a>
          <span class="current-page"><%= currentPage %></span>
          <a href="<%= currentPage < totalPages ? '/pinned?page=' + (currentPage + 1) : '#' %>" class="<%= currentPage < totalPages ? 'next' : 'next disabled' %>">
              <i class="fa-solid fa-arrow-right"></i>
          </a>
      </div>
  <% } %>
  </div>
</div>

<div id="overlay"></div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/pinned.css">
<script src="/js/pinned.js"></script>
<script src="/js/index.js"></script>
<script>
  const recipes = `<%- JSON.stringify(recipes) %>`;
</script>
<script src="/js/search.js"></script>
<script src="https://kit.fontawesome.com/0c466b3931.js" crossorigin="anonymous"></script>
<script>
function openPopup() {
  document.getElementById('popup').style.display = 'block';
  document.getElementById('overlay').style.display = 'block';
  document.body.classList.add('popup-open'); 
}

function closePopup() {
  document.getElementById('folderName').value = '';
  document.getElementById('description').value = '';
  document.getElementById('popup').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
  document.body.classList.remove('popup-open'); 
}

function closeAddPopup() {
  uncheckAll();
  document.getElementById('folderPopup').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
  document.body.classList.remove('popup-open'); 
}

function uncheckAll() {
  // Dapatkan semua elemen input dengan tipe 'checkbox' di dalam div 'addContent'
  var checkboxes = document.querySelectorAll('.folderPopup .addContent input[type="checkbox"]');
  
  // Iterasi melalui setiap checkbox dan hapus ceklisnya
  checkboxes.forEach(function(checkbox) {
    checkbox.checked = false;
  });
}


document.getElementById('folderForm').addEventListener('submit', function(event) {
  event.preventDefault();
  let folderName = document.getElementById('folderName').value;
  let description = document.getElementById('description').value;
});

// Mengambil elemen textarea dan elemen untuk menampilkan jumlah karakter
const descriptionInput = document.getElementById('description');
const charCountDisplay = document.getElementById('charCount');

// Menambahkan event listener untuk input pada textarea
descriptionInput.addEventListener('input', function() {
  // Mengambil jumlah karakter yang diketik
  const charCount = descriptionInput.value.length;
  // Menampilkan jumlah karakter di dalam elemen
  charCountDisplay.textContent = charCount + '/300 characters' ;
});


// Menggunakan jQuery untuk melakukan AJAX request, Anda dapat menyesuaikan dengan metode lain jika diperlukan
$('#folderForm').submit(function(event) {
    event.preventDefault();
    let folderName = $('#folderName').val();
    let description = $('#description').val();
    
    // Mendapatkan daftar nama folder yang sudah ada
    let existingFolders = $('.created .folder').map(function() {
        return $(this).text().trim();
    }).get();

    // Memeriksa apakah nama folder sudah ada sebelumnya
    if (existingFolders.includes(folderName)) {
        // Jika nama folder sudah ada, tampilkan SweetAlert untuk memberitahu pengguna
        Swal.fire({
            title: 'Error!',
            text: 'Folder with the same name already exists.',
            icon: 'error',
            confirmButtonText: 'OK'
        }).then(() => {
            // Hapus nilai input nama folder dan deskripsi
            $('#folderName').val('');
            $('#description').val('');
        });
        return; // Menghentikan eksekusi selanjutnya
    }  
    else if (folderName.trim() === '') {
        // Jika kosong, tampilkan alert
        Swal.fire({
            title: 'Error!',
            text: 'Please enter a folder name.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
        return;
    }

    // Jika nama folder belum ada sebelumnya, lanjutkan proses pembuatan folder
    $.ajax({
        type: 'POST',
        url: '/folders', // Ganti URL dengan endpoint Anda yang sesuai
        data: { folderName, description },
        success: function(response) {
            closePopup();
            // Tampilkan SweetAlert2 setelah folder berhasil dibuat
            Swal.fire({
                title: 'Folder Created!',
                text: 'Your folder has been created.',
                icon: 'success',
                confirmButtonText: 'OK'
            }).then(() => {
                // Refresh halaman setelah menutup SweetAlert2
                window.location.reload();
            });
        },
        error: function(error) {
            console.error(error);
            // Handle error jika ada
        }
    });
});

$('.add-button').click(function() {
    // Periksa apakah ada folder yang tersedia
    if ($('.addContent input[type="checkbox"]').length === 0) {
        // Jika tidak ada folder tersedia, tampilkan SweetAlert untuk membuat folder pertama kali
        Swal.fire({
            title: 'Make a folder first!',
            text: 'There are no folders available. Please create a folder first.',
            icon: 'warning',
            confirmButtonText: 'OK'
        });
        return; // Menghentikan eksekusi selanjutnya
    }
    // Ambil recipeId dari tombol yang diklik
    var recipeId = $(this).data('id');

    // Tampilkan popup
    $('#folderPopup').show().data('id', recipeId);
    document.getElementById('overlay').style.display = 'block';
});

$('#doneButton').click(async function() {
    // Ambil recipeId dari data-id pada popup
    var recipeId = $('#folderPopup').data('id');

    // Ambil folder yang dipilih
    var selectedFolders = [];
    $('input[type=checkbox]:checked').each(function() {
        selectedFolders.push($(this).val());
    });

    try {
        // Kirim data ke server
        const response = await fetch('/addToFolder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ recipeId: recipeId, folders: selectedFolders })
        });

        if (response.ok) {
            // Sembunyikan popup setelah pengiriman data berhasil
            uncheckAll();
            $('#folderPopup').hide();
            document.getElementById('overlay').style.display = 'none';
            // Tampilkan SweetAlert2 untuk memberi tahu pengguna bahwa resep telah ditambahkan ke folder
            Swal.fire({
                title: 'Success!',
                text: 'Your recipe has been added to the selected folder(s).',
                icon: 'success',
                confirmButtonText: 'OK'
            });
        } else {
            // Handle error
            console.error('Error:', response.statusText);
        }
    } catch (error) {
        console.error('Error:', error);
    }
});
</script>